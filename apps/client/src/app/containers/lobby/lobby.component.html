<div class="lobby-container">
  <div class="lobby-header">
    <h1>Pokemon Duel</h1>
    <p>Challenge your friends in real-time battles!</p>
  </div>

  @if (error()) {
    <div class="error-banner">
      <mat-icon>warning</mat-icon>
      <span>{{ error() }}</span>
    </div>
  }

  @if (!isInRoom()) {
    <div class="lobby-cards">
      <mat-card appearance="outlined" class="lobby-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-avatar">meeting_room</mat-icon>
          <mat-card-title>Create Room</mat-card-title>
          <mat-card-subtitle>Start a new game</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>Create a room and invite a friend to join with a room code.</p>
        </mat-card-content>
        <mat-card-actions>
          <button
            mat-flat-button
            [disabled]="isLoading()"
            (click)="createRoom()">
            @if (isLoading() && roomState() === 'creating') {
              <mat-spinner diameter="20"></mat-spinner>
            }
            {{ isLoading() && roomState() === 'creating' ? 'Creating...' : 'Create New Room' }}
          </button>
        </mat-card-actions>
      </mat-card>

      <mat-card appearance="outlined" class="lobby-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-avatar">login</mat-icon>
          <mat-card-title>Join Room</mat-card-title>
          <mat-card-subtitle>Enter a room code</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>Enter a room code to join a friend's game.</p>
          <mat-form-field appearance="outline" class="room-code-field">
            <mat-label>Room Code</mat-label>
            <input
              matInput
              placeholder="ABCD"
              [value]="joinCode()"
              (input)="updateJoinCode($event)"
              maxlength="4"
              [disabled]="isLoading()"
              style="text-transform: uppercase; letter-spacing: 0.3rem; text-align: center;">
            <mat-icon matPrefix>tag</mat-icon>
          </mat-form-field>
        </mat-card-content>
        <mat-card-actions>
          <button
            mat-flat-button
            [disabled]="isLoading() || !joinCode()"
            (click)="joinRoom()">
            @if (isLoading() && roomState() === 'joining') {
              <mat-spinner diameter="20"></mat-spinner>
            }
            {{ isLoading() && roomState() === 'joining' ? 'Joining...' : 'Join' }}
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  } @else {
    <div class="waiting-room">
      <mat-card appearance="outlined" class="waiting-card">
        @if (isWaiting()) {
          <mat-card-content class="waiting-content">
            <mat-spinner diameter="48"></mat-spinner>
            <h2>Waiting for Opponent</h2>

            <div class="room-code-display">
              <span class="code-label">Room Code</span>
              <div class="code-box">
                <span class="code-text">{{ roomCode() }}</span>
                <button mat-icon-button (click)="copyRoomCode()" aria-label="Copy code">
                  <mat-icon>content_copy</mat-icon>
                </button>
              </div>
            </div>

            <p class="waiting-hint">Share this code with your friend to start the battle!</p>

            <mat-chip highlighted>
              <mat-icon matChipAvatar>person</mat-icon>
              You are Player {{ localPlayerId() }}
            </mat-chip>
          </mat-card-content>
        } @else {
          <mat-card-content class="ready-content">
            <mat-icon class="ready-icon">check_circle</mat-icon>
            <h2>Opponent Connected!</h2>
            <p>Both players are ready. Let the battle begin!</p>

            <button mat-flat-button class="start-btn" (click)="navigateToGame()">
              Start Battle!
            </button>
          </mat-card-content>
        }

        <mat-card-actions>
          <button mat-button (click)="leaveRoom()">
            Leave Room
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  }

  <div class="connection-status" [class.connected]="connectionState() === 'connected'">
    <span class="status-dot"></span>
    <span class="status-text">
      @switch (connectionState()) {
        @case ('connected') { Connected }
        @case ('connecting') { Connecting... }
        @case ('reconnecting') { Reconnecting... }
        @case ('error') { Connection Error }
        @default { Disconnected }
      }
    </span>
  </div>
</div>
