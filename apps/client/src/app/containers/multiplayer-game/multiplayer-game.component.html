<div class="game-layout">
  @if (phase() === 'ended' && winnerId()) {
    <div class="win-overlay">
      <div class="win-modal" [class.victory]="localPlayerWon()" [class.defeat]="!localPlayerWon()">
        @if (localPlayerWon()) {
          <mat-icon class="result-icon victory-icon">emoji_events</mat-icon>
          <h2>Victory!</h2>
          <p class="win-message">Congratulations! You won the battle!</p>
        } @else {
          <mat-icon class="result-icon defeat-icon">heart_broken</mat-icon>
          <h2>Defeat</h2>
          <p class="win-message">Your opponent captured your flag!</p>
        }
        <button mat-flat-button (click)="backToLobby()">Back to Lobby</button>
      </div>
    </div>
  }

  @if (lastBattle(); as battle) {
    <div class="battle-toast">
      <div class="battle-header">
        <mat-icon>swords</mat-icon>
        Battle!
      </div>
      <div class="battle-rolls">
        <div class="battle-roll">
          <span class="battle-pokemon">{{ getSpeciesName(getPokemonById(battle.attackerId)?.speciesId ?? '') }}</span>
          <span class="battle-dice">{{ battle.attackerRoll }}{{ battle.attackerBonus > 0 ? ' +' + battle.attackerBonus : '' }}</span>
          <span class="battle-total">= {{ battle.attackerRoll + battle.attackerBonus }}</span>
        </div>
        <div class="battle-vs">VS</div>
        <div class="battle-roll">
          <span class="battle-pokemon">{{ getSpeciesName(getPokemonById(battle.defenderId)?.speciesId ?? '') }}</span>
          <span class="battle-dice">{{ battle.defenderRoll }}{{ battle.defenderBonus > 0 ? ' +' + battle.defenderBonus : '' }}</span>
          <span class="battle-total">= {{ battle.defenderRoll + battle.defenderBonus }}</span>
        </div>
      </div>
      <div class="battle-result">
        {{ getSpeciesName(getPokemonById(battle.winnerId)?.speciesId ?? '') }} wins!
      </div>
    </div>
  }

  <aside class="bench-area bench-area--top" [class.my-bench]="localPlayerId() === 2">
    <app-bench
      [pokemon]="player2Bench()"
      [playerId]="2"
      [selectedPokemonId]="selectedPokemonId()"
      [isCurrentPlayer]="currentPlayerId() === 2 && localPlayerId() === 2"
      (pokemonSelected)="onBenchPokemonSelect($event)"
    />
  </aside>

  <main class="board-area">
    <div class="game-header">
      <div class="header-left">
        <h2>Pokemon Duel</h2>
        <span class="room-code">Room: {{ roomCode() }}</span>
      </div>

      <div class="turn-indicator">
        @if (isMyTurn()) {
          <mat-chip highlighted class="your-turn-chip">
            Your Turn!
          </mat-chip>
        } @else {
          <mat-chip class="opponent-turn-chip">
            Opponent's Turn
          </mat-chip>
        }
        <mat-chip
          [class.turn-player--1]="currentPlayerId() === 1"
          [class.turn-player--2]="currentPlayerId() === 2"
        >
          Player {{ currentPlayerId() }}
        </mat-chip>
      </div>

      <div class="player-info">
        <span class="you-are">You are:</span>
        <mat-chip
          [class.player-badge--1]="localPlayerId() === 1"
          [class.player-badge--2]="localPlayerId() === 2"
        >
          Player {{ localPlayerId() }}
        </mat-chip>
        <button mat-button color="warn" (click)="leaveGame()">
          <mat-icon>exit_to_app</mat-icon>
          Leave
        </button>
      </div>
    </div>

    <div class="board-canvas">
      @for (passage of passages(); track passage.id) {
        @if (getSpotCoords(passage.fromSpotId); as fromCoords) {
          @if (getSpotCoords(passage.toSpotId); as toCoords) {
            <app-passage
              [passage]="passage"
              [fromSpot]="{
                id: passage.fromSpotId,
                x: fromCoords.x,
                y: fromCoords.y,
                name: '',
                metadata: { type: 'normal' },
              }"
              [toSpot]="{
                id: passage.toSpotId,
                x: toCoords.x,
                y: toCoords.y,
                name: '',
                metadata: { type: 'normal' },
              }"
              [xPercent]="toPercentX"
              [yPercent]="toPercentY"
            />
          }
        }
      }

      @if (isMyTurn()) {
        @for (spot of spots(); track spot.id) {
          @if (isValidTarget(spot.id)) {
            <div
              class="valid-target-indicator"
              [class.valid-target-indicator--battle]="isEnemyOccupied(spot.id)"
              [style.left.%]="toPercentX(spot.x)"
              [style.top.%]="toPercentY(spot.y)"
              (click)="onSpotClick(spot)"
            >
              @if (isEnemyOccupied(spot.id)) {
                <span class="battle-icon">
                  <mat-icon>swords</mat-icon>
                </span>
              }
            </div>
          }
        }
      }

      @for (spot of spots(); track spot.id) {
        <app-spot
          [spot]="spot"
          [selected]="false"
          [xPercent]="toPercentX(spot.x)"
          [yPercent]="toPercentY(spot.y)"
          (spotClicked)="onSpotClick($event)"
        />
      }

      @for (pokemon of pokemonOnBoard(); track pokemon.id) {
        @if (getSpotCoords(pokemon.spotId!); as coords) {
          <app-pokemon
            [pokemon]="pokemon"
            [x]="coords.x"
            [y]="coords.y"
            [xPercent]="toPercentX(coords.x)"
            [yPercent]="toPercentY(coords.y)"
            [selected]="selectedPokemonId() === pokemon.id"
            [draggable]="pokemon.playerId === localPlayerId() && isMyTurn() && phase() !== 'ended'"
            (pokemonClicked)="onPokemonClick($event)"
          />
        }
      }
    </div>

    @if (isMyTurn() && selectedPokemonId() && phase() !== 'ended') {
      <div class="selection-info">
        <mat-icon>info</mat-icon>
        <span>Pokemon selected! Click a highlighted spot to move. Red targets = battle!</span>
      </div>
    }

    @if (!isMyTurn() && phase() === 'playing') {
      <div class="waiting-info">
        <mat-icon>hourglass_empty</mat-icon>
        <span>Waiting for opponent to make their move...</span>
      </div>
    }
  </main>

  <aside class="bench-area bench-area--bottom" [class.my-bench]="localPlayerId() === 1">
    <app-bench
      [pokemon]="player1Bench()"
      [playerId]="1"
      [selectedPokemonId]="selectedPokemonId()"
      [isCurrentPlayer]="currentPlayerId() === 1 && localPlayerId() === 1"
      (pokemonSelected)="onBenchPokemonSelect($event)"
    />
  </aside>
</div>
